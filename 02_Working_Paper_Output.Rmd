---
title: "02 Working Paper"
author: "Nate Breznau & Hung H.V. Nguyen"
date: "`r Sys.Date()`"
output: html_document
---

## R Markdown

```{r setup}

source("00_Run_Theory.R")

```

## Generate Model Multiverse

### Input variables

Generate causal matrix

```{r models}
inputs <- list(nodes=c("a","b","c","d"), timing=c(0,-1,-2,-2),
              types=c("otc","test","ctr","ctr"))

causal_matrix <- build_causal_matrix(inputs)
```

### Derive formulas

Generate formula matrix

```{r formula_matrix}

formula_matrix <- build_formula_matrix(causal_matrix)

```

### Add extra plots

```{r xmodels}
formula_matrix <- as.data.frame(formula_matrix)

# Model 3
formula_matrix[(nrow(formula_matrix)+1),] <- c("X4 ~ Y + Xtest,Y ~ X2 + Xtest,Xtest ~ X2 + X1", as.numeric(nrow(formula_matrix)+1), NA) 

# Model 5
formula_matrix[(nrow(formula_matrix)+1),] <- c("Y ~ X2 + Xtest,X3 ~ X2,Xtest ~ X3 + X2 + X1", as.numeric(nrow(formula_matrix)+1), NA)

# added MAS as NA for now
# We should have an option to 'reformulate' formula_matrix, in case the user adds their own formulas. The would serve the purpose of generating mas.

formula_matrix$model <- as.numeric(formula_matrix$model)

```


### Derive plots

#### Update Model Numbers

To match paper

```{r update_formulas}


# arrange models to match paper
# hand done, will break with changes
formula_matrix <- formula_matrix %>%
    mutate(model = case_when(
        model == 6 ~ 1,
        model == 2 ~ 2,
        model == 33 ~ 3,
        model == 8 ~ 4,
        model == 34 ~ 5,
        model == 18 ~ 6,
        model == 1 ~ 18,
        model == 3 ~ 33,
        model == 4 ~ 8,
        model == 5 ~ 34,
        .default = model
    ))

```

#### Generate DAG formulas

```{r gen_dags}
dag_matrix <- build_dag_matrix(formula_matrix)

```

#### Generate Plots

Only need to save models 1-6 for the paper

```{r gen_plots, warning = F}
dag_plots <- plot_dag_matrix(dag_matrix, save_plots = TRUE, choose_save_plots = c(1:6))
```

#### DAG Plots

## Finding Multi MAS DAGs

Using our multiverse generator we search for DAGs that will not easily follow our classification rules

### Generate Models

```{r searching_dags}
inputs <- list(nodes=c("a","b","c","d", "e"), timing=c(0,-1,-2,-3,-3),
              types=c("otc","test","ctr","ctr", "ctr"))

causal_matrix2 <- build_causal_matrix(inputs)

formula_matrix2 <- build_formula_matrix(causal_matrix2)

dag_matrix2 <- build_dag_matrix(formula_matrix2)
```


```{r searching_dags_1}
# use option to indicate different named formula matrix
dag_plots_X1 <- plot_dag_matrix(dag_matrix2, save_plots = T, formula_matrix_name = formula_matrix2, choose_plots_mas = "{ X1 }")

```


### Compare Models with Different MAS

169, 185 & 221 for example have completely different simultaneous MASs.

We see from these plots that they have different ways of closing the backdoor. If having the same MAS is the criteria for being compatible, would these three models fit compatibility?

```{r mascomp}
view(formula_matrix2)

dag_plots2 <- plot_dag_matrix(dag_matrix2, save_plots = TRUE, choose_plots = c(169,185,221), formula_matrix_name = formula_matrix2)

```



