---
title: "02 Working Paper"
author: "Nate Breznau & Hung H.V. Nguyen"
date: "`r Sys.Date()`"
output: html_document
---

## R Markdown

```{r setup}

source("R/build_causal_matrix.R")
source("R/build_formula_matrix.R")
source("R/keep_minimal.R")
```

## Generate Model Multiverse

### Input variables

Generate causal matrix

```{r models}
inputs <- list(nodes=c("a","b","c","d"), timing=c(0,-1,-2,-2),
              types=c("otc","test","ctr","ctr"))

causal_matrix <- build_causal_matrix(inputs)
```

### Derive formulas

Generate formula matrix

```{r formula_matrix}

formula_matrix <- build_formula_matrix(causal_matrix)
```

### Add extra plots

```{r xmodels}
formula_matrix <- as.data.frame(formula_matrix)

# Model 3
formula_matrix[(nrow(formula_matrix)+1),] <- c("X4 ~ Y + Xtest,Y ~ X2 + Xtest,Xtest ~ X2 + X1", as.numeric(nrow(formula_matrix)+1))

# Model 5
formula_matrix[(nrow(formula_matrix)+1),] <- c("Y ~ X2 + Xtest,X3 ~ X2,Xtest ~ X3 + X2 + X1", as.numeric(nrow(formula_matrix)+1))

```


### Derive plots

#### Generate DAG formulas

```{r viz}
coords <- list(
    x = c(Y = 1, Xtest = 0, X1 = -1, X2 = -1, X3 = -0.5, X4 = 1.5),
    y = c(Y = 0, Xtest = 0, X1 = -1, X2 = 1, X3 = 1, X4 = -1)
)

additional_args <- list(
    exposure="Xtest",
    outcome="Y",
    coords = coords
)

full_matrix <- formula_matrix
full_matrix[8,1] <- "Y ~ X2 + Xtest, Xtest ~ X2, X1 ~ X1" # this still doesn't work, the plotting drops the X1
full_matrix_dags <- list()

full_matrix$model <- as.numeric(full_matrix$model)

# arrange models to match paper
# hand done, will break with changes
full_matrix <- full_matrix %>%
    mutate(model = case_when(
        model == 6 ~ 1,
        model == 2 ~ 2,
        model == 33 ~ 3,
        model == 8 ~ 4,
        model == 34 ~ 5,
        model == 18 ~ 6,
        model == 1 ~ 18,
        model == 3 ~ 33,
        model == 4 ~ 8,
        model == 5 ~ 34,
        .default = model
    ))

rownames(full_matrix) <- full_matrix$model
full_matrix <- full_matrix[order(full_matrix$model),]

# note that dagitty uses its own type of object, this means they need to be stored separately in a list
for (f in 1:nrow(full_matrix)) {
    fvector <- strsplit(unlist(full_matrix[f,1]), ",")[[1]]
    # create dag object syntax
    dag <- do.call(dagify, c(lapply(fvector, as.formula), additional_args))
    model <- full_matrix$model[f]
    full_matrix_dags[[model]] <- dag
    # extract adjustment sets
    mas <- adjustmentSets(dag, exposure = "Xtest", outcome = "Y", effect = "direct")
    mas <- ifelse(mas == "list()", "none", capture.output(mas))
    full_matrix$mas[f] <- paste(unlist(mas), collapse = ",")
}

```

#### DAG Plots

Model 1 = 6 
Model 2 = 2
Model 3 = 33
Model 4 = 8 
Model 5 = 34
Model 6 = 18

```{r plots}

dag_plots <- list()

for (l in 1:length(full_matrix_dags)){
    plot(full_matrix_dags[[l]], xlim = c(-1.1,1.1), ylim = c(-1.1,1.1))
    text(0.5,-1, paste0("MAS = ",full_matrix$mas[l]))
    text(0,1, paste0("Model ",full_matrix$model[l]), font = 2)
    dag_plots <- append(dag_plots, list(recordPlot()))
}


```

### Saving Plots

```{r svplots, warning = F}
m = 1
for (n in 1:6) {
    png(file = here::here("Results", paste0("model_", m, ".png")), width = 480, height = 240)
    replayPlot(dag_plots[[n]])
    dev.off()
    m = m+1
}
```






## Finding Multi MAS DAGs

Using our multiverse generator we search for DAGs that will not easily follow our classification rules

### Generate Models

```{r searching_dags}
inputs <- list(nodes=c("a","b","c","d", "e"), timing=c(0,-1,-2,-3,-3),
              types=c("otc","test","ctr","ctr", "ctr"))

causal_matrix2 <- build_causal_matrix(inputs)

formula_matrix2 <- build_formula_matrix(causal_matrix2)



## Add MAS
```


### Find MAS
```{r dagmassearch}
coords <- list(
    x = c(Y = 1, Xtest = 0, X1 = -1, X2 = -2, X3 = -2),
    y = c(Y = 0, Xtest = 0, X1 = 0.5, X2 = 1, X3 = -1)
)

additional_args <- list(
    exposure="Xtest",
    outcome="Y",
    coords = coords
)

full_matrix2 <- formula_matrix2
full_matrix_dags2 <- list()

# note that dagitty uses its own type of object, this means they need to be stored separately in a list
for (f in 1:nrow(formula_matrix2)) {
    print(f)
    fvector <- strsplit(unlist(formula_matrix2[f,1]), ",")[[1]]
    # create dag object syntax
    dag <- do.call(dagify, c(lapply(fvector, as.formula), additional_args))
    model <- full_matrix2$model[f]
    full_matrix_dags2[[model]] <- dag
    # extract adjustment sets
    mas <- adjustmentSets(dag, exposure = "Xtest", outcome = "Y", effect = "direct")
    mas <- ifelse(mas == "list()", "none", capture.output(mas))
    full_matrix2$mas[f] <- paste(unlist(mas), collapse = ",")
}
```

### Exploration Plotting

```{r explot}
dag_plots2 <- list()

for (l in 1:length(full_matrix_dags2)){
    plot(full_matrix_dags2[[l]], xlim = c(-1.1,1.1), ylim = c(-1.1,1.1))
    text(0.5,-1, paste0("MAS = ",full_matrix2$mas[l]))
    text(0,1, paste0("Model ",full_matrix2$model[l]), font = 2)
    dag_plots <- append(dag_plots2, list(recordPlot()))
}
```

