---
title: "02 Working Paper"
author: "Nate Breznau & Hung H.V. Nguyen"
date: "`r Sys.Date()`"
output: html_document
---

## R Markdown

```{r setup}

source("R/build_causal_matrix.R")
source("R/build_formula_matrix.R")
source("R/keep_minimal.R")
```

## Generate Model Multiverse

### Input variables

Generate causal matrix

```{r models}
inputs <- list(nodes=c("a","b","c","d"), timing=c(0,-1,-2,-2),
              types=c("otc","test","ctr","ctr"))

causal_matrix <- build_causal_matrix(inputs)
```

### Derive formulas

Generate formula matrix

```{r formula_matrix}

formula_matrix <- build_formula_matrix(causal_matrix)
```

### Derive plots

#### Generate DAG formulas

```{r viz}
coords <- list(
        x = c(Y = 1, Xtest = 0, X1 = -1, X2 = -1),
        y = c(Y = 0, Xtest = 0, X1 = -1, X2 = 1)
    )

additional_args <- list(
    exposure="Xtest",
    outcome="Y",
    coords = coords
)

full_matrix <- formula_matrix
full_matrix_dags <- list()

# note that dagitty uses its own type of object, this means they need to be stored separately in a list
for (f in 1:nrow(formula_matrix)) {
    print(f)
    fvector <- strsplit(unlist(formula_matrix[f,1]), ",")[[1]]
    # create dag object syntax
    dag <- do.call(dagify, c(lapply(fvector, as.formula), additional_args))
    model <- full_matrix$model[f]
    full_matrix_dags[[model]] <- dag
    # extract adjustment sets
    mas <- adjustmentSets(dag, exposure = "Xtest", outcome = "Y", effect = "direct")
    mas <- ifelse(mas == "list()", "none", mas)
    full_matrix$mas[f] <- mas
}
```

#### DAG Plots

Model 1 = 22 (Version B = 21)
Model 2 = 1
Model 3 = NA - outside of the range
Model 4 = 
Model 5 = 
Model 6 = 

```{r plots}
for (l in 1:length(full_matrix_dags)){
    p <- paste0("p",l)
    assign(p, plot(full_matrix_dags[[l]]))
}


```

```{r viz}
formulas_vector <- strsplit(unlist(reduced_formula_matrix[12,1]), ",")[[1]]
dag2 <- do.call(dagify, c(lapply(formulas_vector, as.formula), additional_args))

```
