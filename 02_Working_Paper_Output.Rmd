---
title: "02 Working Paper"
author: "Nate Breznau & Hung H.V. Nguyen"
date: "`r Sys.Date()`"
output: html_document
---

## R Markdown

```{r setup}

source("00_Run_Theory.R")

```

## Generate Model Multiverse

### Input variables

Generate causal matrix

```{r models}
inputs <- list(nodes=c("a","b","c","d"), timing=c(0,-1,-2,-2),
              types=c("otc","test","ctr","ctr"))

causal_matrix <- build_causal_matrix(inputs)
```

### Derive formulas


#### Add models to causal matrix

```{r xmodels}

causal_matrix <- as.data.frame(causal_matrix)

causal_matrix$model <- as.numeric(causal_matrix$model)

m4 <- max(causal_matrix$model, na.rm = T)+1
# Model 4
causal_matrix[nrow(causal_matrix)+1,] <- c("Y", "Y", "~", m4, 0, "otc", 0, "otc")
causal_matrix[nrow(causal_matrix)+1,] <- c("X4", "X4", "~", m4, 0.5, "ctr", 0.5, "ctr")
causal_matrix[nrow(causal_matrix)+1,] <- c("Xtest", "Xtest", "~", m4, -1, "test", -1, "test")
causal_matrix[nrow(causal_matrix)+1,] <- c("X2", "X2", "~", m4, -2, "ctr", -2, "ctr")
causal_matrix[nrow(causal_matrix)+1,] <- c("X1", "X1", "~", m4, -2, "ctr", -2, "ctr")
causal_matrix[nrow(causal_matrix)+1,] <- c("Y", "X4", "~", m4, 0, "otc", 0.5, "ctr")
causal_matrix[nrow(causal_matrix)+1,] <- c("Xtest", "X4", "~", m4, -1, "test", 0.5, "ctr")
causal_matrix[nrow(causal_matrix)+1,] <- c("Xtest", "Y", "~", m4, -1, "test", 0, "otc")
causal_matrix[nrow(causal_matrix)+1,] <- c("X2", "Y", "~", m4, -2, "ctr", 0, "otc")
causal_matrix[nrow(causal_matrix)+1,] <- c("X2", "Xtest", "~", m4, -2, "ctr", -1, "test")
causal_matrix[nrow(causal_matrix)+1,] <- c("X1", "Xtest", "~", m4, -2, "ctr", -1, "test")
causal_matrix[nrow(causal_matrix)+1,] <- c("X1", "X2", "", m4, -2, "ctr", -2, "ctr")

causal_matrix$model <- as.numeric(causal_matrix$model)

m5 <- max(causal_matrix$model, na.rm = T)+1
# Model 6
causal_matrix[nrow(causal_matrix)+1,] <- c("Y", "Y", "~", m5, 0, "otc", 0, "otc")
causal_matrix[nrow(causal_matrix)+1,] <- c("X3", "X3", "~", m5, -1.5, "ctr", -1.5, "ctr")
causal_matrix[nrow(causal_matrix)+1,] <- c("Xtest", "Xtest", "~", m5, -1, "test", -1, "test")
causal_matrix[nrow(causal_matrix)+1,] <- c("X2", "X2", "~", m5, -2, "ctr", -2, "ctr")
causal_matrix[nrow(causal_matrix)+1,] <- c("X1", "X1", "~", m5, -2, "ctr", -2, "ctr")
causal_matrix[nrow(causal_matrix)+1,] <- c("X2", "X3", "~", m5, -2, "ctr", -1.5, "otc")
causal_matrix[nrow(causal_matrix)+1,] <- c("Xtest", "Y", "~", m5, -1, "test", 0, "otc")
causal_matrix[nrow(causal_matrix)+1,] <- c("X2", "Y", "~", m5, -2, "test", 0, "otc")
causal_matrix[nrow(causal_matrix)+1,] <- c("X2", "Xtest", "~", m5, -2, "ctr", -1, "test")
causal_matrix[nrow(causal_matrix)+1,] <- c("X1", "Xtest", "~", m5, -2, "ctr", -1, "test")
causal_matrix[nrow(causal_matrix)+1,] <- c("X3", "Xtest", "~", m5, -1.5, "test", 0, "ctr")

```

#### Generate formula matrix

```{r formula_matrix}

formula_matrix <- build_formula_matrix(causal_matrix)

```


### Derive plots

#### Update Model Numbers



#### Generate DAG formulas

```{r gen_dags}

dag_matrix <- build_dag_matrix(formula_matrix, add_nodes = 2)

```

#### Generate Plots

Only need to save models 1-6 for the paper

```{r gen_plots, warning = F}
dag_plots <- plot_dag_matrix(dag_matrix, save_plots = TRUE, choose_plots = c(2,6,8,18,33,34), title_labels = c(3,1,5,2,4,6))


```

#### DAG Plots

## Finding Multi MAS DAGs

Using our multiverse generator we search for DAGs that will not easily follow our classification rules

### Generate Models

```{r searching_dags}
inputs <- list(nodes=c("a","b","c","d", "e"), timing=c(0,-1,-2,-3,-3),
              types=c("otc","test","ctr","ctr", "ctr"))

causal_matrix2 <- build_causal_matrix(inputs)

formula_matrix2 <- build_formula_matrix(causal_matrix2)

dag_matrix2 <- build_dag_matrix(formula_matrix2)
```


```{r searching_dags_1}
# use option to indicate different named formula matrix
dag_plots_X1 <- plot_dag_matrix(dag_matrix2, save_plots = T, formula_matrix_name = formula_matrix2, choose_plots_mas = "{ X1 }")

```


### Compare Models with Different MAS

169, 185 & 221 for example have completely different simultaneous MASs.

We see from these plots that they have different ways of closing the backdoor. If having the same MAS is the criteria for being compatible, would these three models fit compatibility?

```{r mascomp}
view(formula_matrix2)

dag_plots2 <- plot_dag_matrix(dag_matrix2, save_plots = TRUE, choose_plots = c(169,185,221), formula_matrix_name = formula_matrix2)

```

### Set Logic Comparison

Starting with causal matrix
1. Identify each component (node / edge) and make categorical as yes/no 1/0
2. Select reference model 
3. Assign test_compatible and full_model_compatible

#### Identify components

```{r set_logic}
causal_matrix_transf <- causal_matrix2 %>%
    mutate(not_component = ifelse(direction == "", 1, 0),
           direction = ifelse(direction == "", "~", direction),
           component_link = ifelse(direction == "~~", "corr",
                            ifelse(direction == "~", "cause", NA)),
           component = paste(from, to, sep = ","),
           component = ifelse(from == to, from, component),
           component_type = ifelse(from == to, "node", "edge"))
```


### Transform into sets

```{r set_build}

for (v in causal_matrix_transf$component) {
causal_matrix_transf[,paste0(v)] <- ifelse(causal_matrix_transf$component == v & causal_matrix_transf$not_component == 0, 1, 0)
}

causal_matrix_transf <- subset(causal_matrix_transf, select = -c(from, to, direction, timing_from, type_from, timing_to, type_to, component, not_component, component_link, component_type, component_factor))

causal_matrix_transf <- causal_matrix_transf %>%
    group_by(model) %>%
    summarise_all(max, na.rm = T)


```

#### Add MAS

Use MAS as an example here, but in the future we will use test_compatible and test_model_compatible

```{r formula_mas}
mas <- subset(formula_matrix2, select = c(model, mas))

causal_matrix_transf <- causal_matrix_transf %>%
    left_join(mas, by = "model")

# make MAS = "{X2}" the outcome
causal_matrix_transf <- causal_matrix_transf %>%
    mutate(outcome = ifelse(mas == "{ X2 }", 1, 0)) %>%
    select(-c(model,mas))
```


#### QCA

Use set logic to identify the MAS outcome { X2 }

Need to use a case study that has models with excluded nodes, and a confounder to see the full potential. 

The next step is to use test_compare and test_model_compare as the outcome

```{r qca}
test <- truthTable(as.data.frame(causal_matrix_transf), "outcome")

pof(setms = select(as.data.frame(causal_matrix_transf), -outcome), outcome = "outcome", data = as.data.frame(causal_matrix_transf))
```

