---
title: "02 Working Paper"
author: "Nate Breznau & Hung H.V. Nguyen"
date: "`r Sys.Date()`"
output: html_document
---

## R Markdown

```{r setup}

source("R/theoRy.R")

```

## Generate Model Multiverse

### Input variables

Generate causal matrix

```{r models}
nodes <- c("a","b","c","d")
timing <- c(-2,1,-1,0)
types <- c("ctr","ctr","test","otc")
base_mod <- "d ~ a + c; c~a"


causal_matrix <- build_causal_matrix(nodes, types, timing, include_subsets=TRUE, base_mod = base_mod)
formula_matrix <- build_formula_matrix(causal_matrix)

ref_mod <- as.numeric(unique(formula_matrix[base_mod==1,"model"]))

cmp_matrix <- test_compatible(formula_matrix, ref_mod = ref_mod) %>%
    left_join(formula_matrix, by = "model") %>%
    arrange(model) %>%
    mutate(
        full_model_compatible = case_when(
            test_compatible == "reference_model" ~ "reference_model",
            correct_test == "yes" & test_compatible == "compatible" ~ "compatible",
            TRUE ~ "incompatible"
        )
    )


```

### Derive formulas


#### Add models to causal matrix

```{r xmodels}

causal_matrix <- as.data.frame(causal_matrix)

causal_matrix$model <- as.numeric(causal_matrix$model)

m4 <- max(causal_matrix$model, na.rm = T)+1
# Model 4
causal_matrix[nrow(causal_matrix)+1,] <- c("Y", "Y", "~", m4, 0, "otc", 0, "otc")
causal_matrix[nrow(causal_matrix)+1,] <- c("X4", "X4", "~", m4, 0.5, "ctr", 0.5, "ctr")
causal_matrix[nrow(causal_matrix)+1,] <- c("Xtest", "Xtest", "~", m4, -1, "test", -1, "test")
causal_matrix[nrow(causal_matrix)+1,] <- c("X2", "X2", "~", m4, -2, "ctr", -2, "ctr")
causal_matrix[nrow(causal_matrix)+1,] <- c("X1", "X1", "~", m4, -2, "ctr", -2, "ctr")
causal_matrix[nrow(causal_matrix)+1,] <- c("Y", "X4", "~", m4, 0, "otc", 0.5, "ctr")
causal_matrix[nrow(causal_matrix)+1,] <- c("Xtest", "X4", "~", m4, -1, "test", 0.5, "ctr")
causal_matrix[nrow(causal_matrix)+1,] <- c("Xtest", "Y", "~", m4, -1, "test", 0, "otc")
causal_matrix[nrow(causal_matrix)+1,] <- c("X2", "Y", "~", m4, -2, "ctr", 0, "otc")
causal_matrix[nrow(causal_matrix)+1,] <- c("X2", "Xtest", "~", m4, -2, "ctr", -1, "test")
causal_matrix[nrow(causal_matrix)+1,] <- c("X1", "Xtest", "~", m4, -2, "ctr", -1, "test")
causal_matrix[nrow(causal_matrix)+1,] <- c("X1", "X2", "", m4, -2, "ctr", -2, "ctr")

causal_matrix$model <- as.numeric(causal_matrix$model)

m5 <- max(causal_matrix$model, na.rm = T)+1
# Model 6
causal_matrix[nrow(causal_matrix)+1,] <- c("Y", "Y", "~", m5, 0, "otc", 0, "otc")
causal_matrix[nrow(causal_matrix)+1,] <- c("X3", "X3", "~", m5, -1.5, "ctr", -1.5, "ctr")
causal_matrix[nrow(causal_matrix)+1,] <- c("Xtest", "Xtest", "~", m5, -1, "test", -1, "test")
causal_matrix[nrow(causal_matrix)+1,] <- c("X2", "X2", "~", m5, -2, "ctr", -2, "ctr")
causal_matrix[nrow(causal_matrix)+1,] <- c("X1", "X1", "~", m5, -2, "ctr", -2, "ctr")
causal_matrix[nrow(causal_matrix)+1,] <- c("X2", "X3", "~", m5, -2, "ctr", -1.5, "otc")
causal_matrix[nrow(causal_matrix)+1,] <- c("Xtest", "Y", "~", m5, -1, "test", 0, "otc")
causal_matrix[nrow(causal_matrix)+1,] <- c("X2", "Y", "~", m5, -2, "test", 0, "otc")
causal_matrix[nrow(causal_matrix)+1,] <- c("X2", "Xtest", "~", m5, -2, "ctr", -1, "test")
causal_matrix[nrow(causal_matrix)+1,] <- c("X1", "Xtest", "~", m5, -2, "ctr", -1, "test")
causal_matrix[nrow(causal_matrix)+1,] <- c("X3", "Xtest", "~", m5, -1.5, "test", 0, "ctr")

```

#### Generate formula matrix

```{r formula_matrix}

formula_matrix <- build_formula_matrix(causal_matrix)

```


### Derive plots

#### Update Model Numbers



#### Generate DAG formulas

```{r gen_dags}

dag_matrix <- build_dag_matrix(formula_matrix, add_nodes = 2)

```

#### Generate Plots

Only need to save models 1-6 for the paper

```{r gen_plots, warning = F}
dag_plots <- plot_dag_matrix(dag_matrix, save_plots = TRUE, choose_plots = c(2,6,8,18,33,34), title_labels = c(3,1,5,2,4,6))


```

##### Playing around with plotting as ggdag

```{r ggdag}

fvector <- strsplit(as.character(formula_matrix[1]), ",")[[1]]
dag_args <- lapply(fvector, as.formula)
additional_args <- list(
     exposure="Xtest",
     outcome="Y"
     )

d1 <- do.call(dagify, c(dag_args, additional_args))


ggdag(d1)

d1plot <- ggdag(d1) +
    geom_dag_edges(edge_color = "green")

```

## Comparing DAGs

### Generate Models

#### Different Configurations

We will develop an easier method, but for now we do the 'long way' of assembling all (most) possible model combinations of the edges and nodes

```{r searching_dags}
inputs <- list(nodes=c("a","b","c","d","e","f"),
                timing=c(0,-1,-2,-3,-3, 1),
                types=c("otc","test","ctr","ctr", "ctr","ctr"))


causal_matrix1 <- build_causal_matrix(inputs) %>%
    mutate(direction = ifelse(is.na(direction), "~", direction)) # this deals with the NA bug for variables happening after Y

formula_matrix1 <- build_formula_matrix(causal_matrix1)

# without X4
causal_matrix2 <- causal_matrix1 %>%
    subset(to != "X4") %>%
    subset(from != "X4")
# this automatically removes duplicates
formula_matrix2 <- build_formula_matrix(causal_matrix2)

# without X3
causal_matrix3 <- causal_matrix1 %>%
    subset(to != "X3") %>%
    subset(from != "X3")

formula_matrix3 <- build_formula_matrix(causal_matrix3)

# without X2
causal_matrix4 <- causal_matrix1 %>%
    subset(to != "X2") %>%
    subset(from != "X2")

formula_matrix4 <- build_formula_matrix(causal_matrix4)

# without X1
causal_matrix5 <- causal_matrix1 %>%
    subset(to != "X1") %>%
    subset(from != "X1")

formula_matrix5 <- build_formula_matrix(causal_matrix5)

# without X3 and X4
causal_matrix6 <- causal_matrix1 %>%
    subset(to != "X1" & to != "X2") %>%
    subset(from != "X1" & from != "X2")

formula_matrix6 <- build_formula_matrix(causal_matrix6)

#subset and re-number to have order
causal_matrix2 <- causal_matrix2 %>%
    subset(model %in% formula_matrix2$model) %>%
    transform(model = (as.numeric(factor(model))+max(causal_matrix1$model)))

causal_matrix3 <- causal_matrix3 %>%
    subset(model %in% formula_matrix3$model) %>%
    transform(model = (as.numeric(factor(model))+max(causal_matrix2$model)))

causal_matrix4 <- causal_matrix4 %>%
    subset(model %in% formula_matrix4$model) %>%
    transform(model = (as.numeric(factor(model))+max(causal_matrix3$model)))

causal_matrix5 <- causal_matrix5 %>%
    subset(model %in% formula_matrix5$model) %>%
    transform(model = (as.numeric(factor(model))+max(causal_matrix4$model)))

causal_matrix6 <- causal_matrix6 %>%
    subset(model %in% formula_matrix6$model) %>%
    transform(model = (as.numeric(factor(model))+max(causal_matrix5$model)))


causal_matrix <- rbind(causal_matrix1, causal_matrix2, causal_matrix3, causal_matrix4, causal_matrix5, causal_matrix6)

formula_matrix <- rbind(formula_matrix1, formula_matrix2, formula_matrix3, formula_matrix4, formula_matrix5, formula_matrix6)

formula_matrix <- formula_matrix %>%
    mutate(model = row_number())

```


### Set Logic Comparison

Starting with causal matrix
1. Identify each component (node / edge) and make categorical as yes/no 1/0
2. Select reference model
3. Assign test_compatible and full_model_compatible



#### Identify components

```{r set_logic}
causal_matrix_transf <- causal_matrix %>%
    mutate(not_component = ifelse(direction == "", 1, 0),
           direction = ifelse(direction == "", "~", direction),
           component_link = ifelse(direction == "~~", "corr",
                            ifelse(direction == "~", "cause", NA)),
           component = paste(from, to, sep = "_"),
           component = ifelse(from == to, from, component),
           component_type = ifelse(from == to, "node", "edge"))
```


### Transform into sets

```{r set_build}


# v1 <- causal_matrix_transf[causal_matrix_transf$model < 4001]
# v2 <- causal_matrix_transf[causal_matrix_transf$model > 4000 & causal_matrix_transf$model < 8001]
# v3 <- causal_matrix_transf[causal_matrix_transf$model > 8000 & causal_matrix_transf$model < 12001]
# v4 <- causal_matrix_transf[causal_matrix_transf$model > 12000]

for (v in causal_matrix_transf$component) {
v1[,paste0(v)] <- ifelse(v1$component == v & v1$not_component == 0, 1, 0)
}

for (v in causal_matrix_transf$component) {
v2[,paste0(v)] <- ifelse(v2$component == v & v2$not_component == 0, 1, 0)
}

for (v in causal_matrix_transf$component) {
v3[,paste0(v)] <- ifelse(v3$component == v & v3$not_component == 0, 1, 0)
}

for (v in causal_matrix_transf$component) {
v4[,paste0(v)] <- ifelse(v4$component == v & v4$not_component == 0, 1, 0)
}

causal_matrix_transf <- rbind(v1, v2, v3, v4)

causal_matrix_transf <- subset(causal_matrix_transf, select = -c(from, to, direction, timing_from, type_from, timing_to, type_to, component, not_component, component_link, component_type))

causal_matrix_transf <- causal_matrix_transf %>%
    group_by(model) %>%
    summarise_all(max, na.rm = T)


```

#### Add MAS

Use MAS as an example here, but in the future we will use test_compatible and test_model_compatible

```{r formula_mas}
mas <- subset(formula_matrix, select = c(model, mas))

causal_matrix_transf <- causal_matrix_transf %>%
    left_join(mas, by = "model")

# make MAS = "{X1}" the outcome, this fits with the X4 models
causal_matrix_transf_X1 <- causal_matrix_transf %>%
    mutate(outcome = ifelse(mas == "{ X1 }", 1, 0)) %>%
    select(-c(model,mas))
```


#### QCA

Use set logic to identify the MAS outcome { X2 }

Need to use a case study that has models with excluded nodes, and a confounder to see the full potential.

The next step is to use test_compare and test_model_compare as the outcome

##### Single Components

This can help us understand the role of single components. However, for most causal models a single component is rarely alone so important. For example a node often requires specific edges before it becomes important (e.g., becomes a confounder or collider)

```{r qca}
test <- truthTable(as.data.frame(causal_matrix_transf), "outcome")

pof(setms = select(as.data.frame(causal_matrix_transf_X1), -outcome), outcome = "outcome", data = as.data.frame(causal_matrix_transf_X1))

# try option relation = "sufficiency"

#inclN = inclusion = what percent of all models have outcome (Y = 1) and this component (X = 1)
#covN = necessity coverage = what percent of all models with this component (X = 1) have the outcome (Y = 1)
#RoN = relevence of necessity = is a necessary condition trivial
```

              inclN   RoN   covN  
--------------------------------- 
 1     X1_X2  0.479  0.562  0.127 
 2     X1_X3  0.479  0.562  0.127 
 3  X1_Xtest  1.000  0.588  0.257 
 4      X1_Y  1.000  0.588  0.257 
 5     X1_X4  0.486  0.563  0.129 
 6     X2_X3  0.401  0.556  0.106 
 7  X2_Xtest  0.300  0.535  0.077 
 8      X2_Y  0.300  0.535  0.077 
 9     X2_X4  0.465  0.561  0.123 
10  X3_Xtest  0.300  0.534  0.077 
11      X3_Y  0.300  0.534  0.077 
12     X3_X4  0.465  0.560  0.123 
13  Xtest_X4  0.486  0.547  0.125 
14      Y_X4  0.486  0.547  0.125 
15        X1  1.000  0.034  0.129 
16        X2  0.958  0.033  0.123 
17        X3  0.958  0.031  0.123 
18     Xtest  1.000  0.000  0.125 
19   Xtest_Y  1.000  0.000  0.125 
20         Y  1.000  0.000  0.125 
21        X4  0.972  0.032  0.125 
---------------------------------

##### Multiple Component Analyses

###### Minimize

Looking only positive outcomes (outcome = 1/MAS = {X1}), this procedure tries to find minimal sets of variables that are present in all positive cases, regardless of if these sets are present in outcome = 0 cases.

```{r minimize}

min_results <- minimize(as.data.frame(causal_matrix_transf_X1), details = TRUE, outcome = "outcome")

```


###### Subsets

```{r qca}
superSubset(as.data.frame(causal_matrix_transf_X1), outcome = "outcome")
```

                                      inclN   RoN   covN  
--------------------------------------------------------- 
 1  X1_Xtest                          1.000  0.588  0.257 
 2  X1_Y                              1.000  0.588  0.257 
 3  X1                                1.000  0.034  0.129 
 4  Xtest                             1.000  0.000  0.125 
 5  Xtest_Y                           1.000  0.000  0.125 
 6  Y                                 1.000  0.000  0.125 
 7  X1_Xtest*X1_Y                     1.000  0.865  0.514 
 8  X1_Xtest*X1                       1.000  0.588  0.257 
 9  X1_Xtest*Xtest                    1.000  0.588  0.257 
10  X1_Xtest*Xtest_Y                  1.000  0.588  0.257 
11  X1_Xtest*Y                        1.000  0.588  0.257 
12  X1_Y*X1                           1.000  0.588  0.257 
13  X1_Y*Xtest                        1.000  0.588  0.257 
14  X1_Y*Xtest_Y                      1.000  0.588  0.257 
15  X1_Y*Y                            1.000  0.588  0.257 
16  X1*Xtest                          1.000  0.034  0.129 
17  X1*Xtest_Y                        1.000  0.034  0.129 
18  X1*Y                              1.000  0.034  0.129 
19  Xtest*Xtest_Y                     1.000  0.000  0.125 
20  Xtest*Y                           1.000  0.000  0.125 
21  Xtest_Y*Y                         1.000  0.000  0.125 
22  X1_Xtest*X1_Y*X1                  1.000  0.865  0.514 
23  X1_Xtest*X1_Y*Xtest               1.000  0.865  0.514 
24  X1_Xtest*X1_Y*Xtest_Y             1.000  0.865  0.514 
25  X1_Xtest*X1_Y*Y                   1.000  0.865  0.514 
26  X1_Xtest*X1*Xtest                 1.000  0.588  0.257 
27  X1_Xtest*X1*Xtest_Y               1.000  0.588  0.257 
28  X1_Xtest*X1*Y                     1.000  0.588  0.257 
29  X1_Xtest*Xtest*Xtest_Y            1.000  0.588  0.257 
30  X1_Xtest*Xtest*Y                  1.000  0.588  0.257 
31  X1_Xtest*Xtest_Y*Y                1.000  0.588  0.257 
32  X1_Y*X1*Xtest                     1.000  0.588  0.257 
33  X1_Y*X1*Xtest_Y                   1.000  0.588  0.257 
34  X1_Y*X1*Y                         1.000  0.588  0.257 
35  X1_Y*Xtest*Xtest_Y                1.000  0.588  0.257 
36  X1_Y*Xtest*Y                      1.000  0.588  0.257 
37  X1_Y*Xtest_Y*Y                    1.000  0.588  0.257 
38  X1*Xtest*Xtest_Y                  1.000  0.034  0.129 
39  X1*Xtest*Y                        1.000  0.034  0.129 
40  X1*Xtest_Y*Y                      1.000  0.034  0.129 
41  Xtest*Xtest_Y*Y                   1.000  0.000  0.125 
42  X1_Xtest*X1_Y*X1*Xtest            1.000  0.865  0.514 
43  X1_Xtest*X1_Y*X1*Xtest_Y          1.000  0.865  0.514 
44  X1_Xtest*X1_Y*X1*Y                1.000  0.865  0.514 
45  X1_Xtest*X1_Y*Xtest*Xtest_Y       1.000  0.865  0.514 
46  X1_Xtest*X1_Y*Xtest*Y             1.000  0.865  0.514 
47  X1_Xtest*X1_Y*Xtest_Y*Y           1.000  0.865  0.514 
48  X1_Xtest*X1*Xtest*Xtest_Y         1.000  0.588  0.257 
49  X1_Xtest*X1*Xtest*Y               1.000  0.588  0.257 
50  X1_Xtest*X1*Xtest_Y*Y             1.000  0.588  0.257 
51  X1_Xtest*Xtest*Xtest_Y*Y          1.000  0.588  0.257 
52  X1_Y*X1*Xtest*Xtest_Y             1.000  0.588  0.257 
53  X1_Y*X1*Xtest*Y                   1.000  0.588  0.257 
54  X1_Y*X1*Xtest_Y*Y                 1.000  0.588  0.257 
55  X1_Y*Xtest*Xtest_Y*Y              1.000  0.588  0.257 
56  X1*Xtest*Xtest_Y*Y                1.000  0.034  0.129 
57  X1_Xtest*X1_Y*X1*Xtest*Xtest_Y    1.000  0.865  0.514 
58  X1_Xtest*X1_Y*X1*Xtest*Y          1.000  0.865  0.514 
59  X1_Xtest*X1_Y*X1*Xtest_Y*Y        1.000  0.865  0.514 
60  X1_Xtest*X1_Y*Xtest*Xtest_Y*Y     1.000  0.865  0.514 
61  X1_Xtest*X1*Xtest*Xtest_Y*Y       1.000  0.588  0.257 
62  X1_Y*X1*Xtest*Xtest_Y*Y           1.000  0.588  0.257 
63  X1_Xtest*X1_Y*X1*Xtest*Xtest_Y*Y  1.000  0.865  0.514 
64  ~X1_X2 + X2                       1.000  0.000  0.125 
65  ~X1_X3 + X3                       1.000  0.000  0.125 
66  ~X1_X4 + X4                       1.000  0.000  0.125 
67  ~X2_X3 + X2                       1.000  0.000  0.125 
68  ~X2_X3 + X3                       1.000  0.000  0.125 
69  ~X2_Xtest + ~X2_Y                 1.000  0.277  0.165 
70  ~X2_Xtest + X2                    1.000  0.000  0.125 
71  ~X2_Y + X2                        1.000  0.000  0.125 
72  ~X2_X4 + X2                       1.000  0.000  0.125 
73  ~X2_X4 + X4                       1.000  0.000  0.125 
74  ~X3_Xtest + ~X3_Y                 1.000  0.278  0.165 
75  ~X3_Xtest + X3                    1.000  0.000  0.125 
76  ~X3_Y + X3                        1.000  0.000  0.125 
77  ~X3_X4 + X3                       1.000  0.000  0.125 
78  ~X3_X4 + X4                       1.000  0.000  0.125 
79  ~Xtest_X4 + X4                    1.000  0.000  0.125 
80  ~Y_X4 + X4                        1.000  0.000  0.125 
81  X2 + X3                           1.000  0.000  0.125 
82  X2 + X4                           1.000  0.000  0.125 
83  X3 + X4                           1.000  0.000  0.125 
84  ~X2_X3 + ~X2_Xtest + ~X3_Y        1.000  0.135  0.141 
85  ~X2_X3 + ~X2_Y + ~X3_Xtest        1.000  0.135  0.141 
--------------------------------------------------------- 

